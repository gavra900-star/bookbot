<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

const N8N_WEBHOOK_URL = 'https://cintre.app.n8n.cloud/webhook/bookbot-generate';
const N8N_SAVE_URL    = 'https://cintre.app.n8n.cloud/webhook/bookbot-save';
const N8N_LIST_URL    = 'https://cintre.app.n8n.cloud/webhook/bookbot-list';

let state = {
  text: '',
  generatedChapter: '',
  isSaved: false,
  userId: tg?.initDataUnsafe?.user?.id || 'dev_user',
  userName: tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
};
let currentScreen = 1;

// Navigation
function goTo(n) {
  const from = document.getElementById(`screen-${currentScreen}`);
  const to = document.getElementById(`screen-${n}`);
  from.classList.add('exit-left');
  from.classList.remove('active');
  setTimeout(() => from.classList.remove('exit-left'), 350);
  to.style.transform = n > currentScreen ? 'translateX(40px)' : 'translateX(-40px)';
  to.classList.add('active');
  currentScreen = n;
  to.scrollTop = 0;
}

function openBook() {
  goTo(5);
  loadChapters();
}

function updateCharCount() {
  const ta = document.getElementById('day-input');
  const cc = document.getElementById('char-count');
  const len = ta.value.length;
  cc.textContent = `${len} / 450`;
  cc.className = 'char-count' + (len >= 50 ? ' ok' : '');
  state.text = ta.value;
}

// Voice
let recognition = null, isRecording = false;
function toggleVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showToast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ'); return; }
  isRecording ? stopVoice() : startVoice();
}
function startVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'ru-RU';
  recognition.continuous = true;
  recognition.interimResults = true;
  const ta = document.getElementById('day-input');
  const base = ta.value;

  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    ta.value = base + (base && final ? ' ' : '') + final + interim;
    updateCharCount();
  };
  recognition.onerror = () => { stopVoice(); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'); };
  recognition.onend = () => { if (isRecording) stopVoice(); };

  recognition.start();
  isRecording = true;
  document.getElementById('voice-btn').classList.add('recording');
  document.getElementById('voice-label').textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
}
function stopVoice() {
  recognition?.stop();
  recognition = null;
  isRecording = false;
  document.getElementById('voice-btn').classList.remove('recording');
  document.getElementById('voice-label').textContent = '–ì–æ–ª–æ—Å–æ–º';
}

// Generate
async function generate() {
  const text = document.getElementById('day-input').value.trim();
  if (text.length < 10) { showToast('–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π'); return; }

  state.text = text;
  goTo(3);
  animateLoadingSteps();

  try {
    const resp = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: state.userId,
        user_name: state.userName,
        text: state.text
      })
    });

    const raw = await resp.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { raw }; }

    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${raw}`);

    const d = Array.isArray(data) ? data[0] : data;
    const chapter =
      d?.chapter ??
      d?.output ??
      d?.text ??
      d?.data?.chapter ??
      d?.result?.chapter ??
      d?.message?.content ??
      '';

    if (!chapter || typeof chapter !== 'string') {
      console.error('Unexpected n8n response:', data);
      throw new Error('empty chapter');
    }

    state.generatedChapter = chapter.trim();
    state.isSaved = false;
    showResult(state.generatedChapter);
  } catch (e) {
    console.error('Generate error:', e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–ª–∞–≤—É –∏–∑ n8n');
    goTo(2);
  }
}

let loadingTimer;
function animateLoadingSteps() {
  [1,2,3].forEach(i => {
    document.getElementById(`lstep-${i}`).className = 'loading-step';
    document.getElementById(`licon-${i}`).textContent = '‚óã';
  });
  let i = 0;
  (function next() {
    if (i < 3) {
      if (i > 0) {
        document.getElementById(`lstep-${i}`).classList.add('done');
        document.getElementById(`licon-${i}`).textContent = '‚úì';
      }
      document.getElementById(`lstep-${i+1}`).classList.add('active');
      i++;
      loadingTimer = setTimeout(next, 1800);
    }
  })();
}

function showResult(chapter) {
  clearTimeout(loadingTimer);
  [1,2,3].forEach(i => {
    document.getElementById(`lstep-${i}`).className = 'loading-step done';
    document.getElementById(`licon-${i}`).textContent = '‚úì';
  });

  setTimeout(() => {
    document.getElementById('chapter-output').textContent = chapter;
    document.getElementById('chapter-words').textContent = `${chapter.split(/\s+/).length} —Å–ª–æ–≤`;
    document.getElementById('result-date').textContent =
      new Date().toLocaleDateString('ru', { day: 'numeric', month: 'long' });

    const saveBlock = document.getElementById('save-block');
    saveBlock.classList.remove('saved');
    document.getElementById('save-btn').disabled = false;
    document.getElementById('save-btn').textContent = 'üìö –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–Ω–∏–≥—É';
    document.getElementById('open-book-btn').style.display = 'none';

    goTo(4);
  }, 600);
}

// Save
async function saveChapter() {
  if (state.isSaved) return;

  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';

  try {
    const resp = await fetch(N8N_SAVE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: state.userId,
        user_name: state.userName,
        text: state.text,
        chapter: state.generatedChapter,
        date: new Date().toISOString()
      })
    });

    if (!resp.ok) {
      const errText = await resp.text();
      throw new Error(`SAVE HTTP ${resp.status}: ${errText}`);
    }

    state.isSaved = true;
    document.getElementById('save-block').classList.add('saved');
    document.getElementById('open-book-btn').style.display = 'flex';
    showToast('–ì–ª–∞–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–Ω–∏–≥—É! üìñ');
  } catch (e) {
    console.error('Save chapter error:', e);
    btn.disabled = false;
    btn.textContent = 'üìö –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–Ω–∏–≥—É';
    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞');
  }
}

// Load chapters
async function loadChapters() {
  document.getElementById('book-loading').style.display = 'flex';
  document.getElementById('book-empty').style.display = 'none';
  document.getElementById('chapters-list').style.display = 'none';
  document.getElementById('book-count').textContent = '...';

  try {
    const resp = await fetch(N8N_LIST_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: state.userId })
    });

    if (!resp.ok) {
      const errText = await resp.text();
      throw new Error(`LIST HTTP ${resp.status}: ${errText}`);
    }

    const data = await resp.json();
    const d = Array.isArray(data) ? data[0] : data;
    const chapters = d?.chapters || [];
    renderChapters(Array.isArray(chapters) ? chapters : []);
  } catch (e) {
    console.error('Load chapters error:', e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É');
    renderChapters([]);
  }
}

function renderChapters(chapters) {
  document.getElementById('book-loading').style.display = 'none';
  document.getElementById('book-count').textContent =
    `${chapters.length} ${pluralChapters(chapters.length)}`;

  if (chapters.length === 0) {
    document.getElementById('book-empty').style.display = 'flex';
    return;
  }

  const list = document.getElementById('chapters-list');
  list.style.display = 'flex';
  list.innerHTML = '';

  chapters.forEach((ch, idx) => {
    const num = chapters.length - idx;
    const date = ch.created_at
      ? new Date(ch.created_at).toLocaleDateString('ru', { day:'numeric', month:'long', year:'numeric' })
      : '';
    const preview = (ch.chapter || '').slice(0, 60) + ((ch.chapter || '').length > 60 ? '...' : '');

    const safeChapter = JSON.stringify(ch.chapter || '');

    const item = document.createElement('div');
    item.className = 'chapter-item';
    item.innerHTML = `
      <div class="chapter-item-header" onclick="toggleChapter(this)">
        <div class="chapter-item-left">
          <div class="chapter-item-num">–ì–ª–∞–≤–∞ ${num}</div>
          <div class="chapter-item-preview">${preview}</div>
          <div class="chapter-item-date">${date}</div>
        </div>
        <span class="chapter-item-arrow">‚ñæ</span>
      </div>
      <div class="chapter-item-body">
        <div class="chapter-item-text">${ch.chapter || ''}</div>
        <div class="chapter-item-actions">
          <button class="chip-btn" onclick='copyText(${safeChapter})'>‚ßâ –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    `;
    list.appendChild(item);
  });
}

function toggleChapter(header) {
  const item = header.closest('.chapter-item');
  const wasOpen = item.classList.contains('open');
  document.querySelectorAll('.chapter-item.open').forEach(el => el.classList.remove('open'));
  if (!wasOpen) item.classList.add('open');
}

function copyText(text) {
  navigator.clipboard?.writeText(text)
    .then(() => showToast('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úì'))
    .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
}

function pluralChapters(n) {
  if (n % 100 >= 11 && n % 100 <= 19) return '–≥–ª–∞–≤';
  const r = n % 10;
  if (r === 1) return '–≥–ª–∞–≤–∞';
  if (r >= 2 && r <= 4) return '–≥–ª–∞–≤—ã';
  return '–≥–ª–∞–≤';
}

// Share / new
function copyChapter() {
  navigator.clipboard?.writeText(state.generatedChapter)
    .then(() => showToast('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úì'))
    .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
}
function shareChapter() {
  tg?.switchInlineQuery
    ? tg.switchInlineQuery(state.generatedChapter.slice(0, 200) + '‚Ä¶')
    : copyChapter();
}
function newChapter() {
  state.text = '';
  state.generatedChapter = '';
  state.isSaved = false;
  document.getElementById('day-input').value = '';
  updateCharCount();
  goTo(2);
}

// Toast
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

document.addEventListener('DOMContentLoaded', updateCharCount);
</script>
